<!DOCTYPE html>
<html lang="en-US">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">

		
		<title>forestmodel给多水平变量添加整体p值 &middot; ShixiangWang
王诗翔</title>
		
		<meta property="og:title" content="forestmodel给多水平变量添加整体p值 - ShixiangWang
王诗翔">
		
		<meta property="og:type" content="article">
		

		
			
			<meta property="description" content="我不是作者，但你问对了人">
			<meta property="og:description" content="我不是作者，但你问对了人">
			
			
    	<meta property="twitter:card" content="summary">
  		<meta property="twitter:image" content="/apple-touch-icon-152x152.png">
			
		

		
		
		<meta name="twitter:creator" content="@WangShxiang">
		<meta name="twitter:site" content="https://shixiangwang.github.io">
		
		

		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
		<link rel="stylesheet" href="../../css/poole.css">
		<link rel="stylesheet" href="../../css/syntax.css">
		<link rel="stylesheet" href="../../css/hyde.css">
		
		
		<link rel="stylesheet" href="../../css/hamburgers.css">
		
		<link rel="stylesheet" href="../../css/custom.css">
		
		

<link rel="apple-touch-icon-precomposed" sizes="57x57" href="../../apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../apple-touch-icon-144x144.png" />
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../apple-touch-icon-152x152.png" />
<link rel="icon" type="image/png" href="../../favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="../../favicon-16x16.png" sizes="16x16" />
<meta name="application-name" content="Garrick Aden-Buie"/>
<meta name="msapplication-TileColor" content="#002B36" />
<meta name="msapplication-TileImage" content="/mstile-144x144.png" />
<meta name="theme-color" content="#ffffff">

<meta name="mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Garrick Aden-Buie">

<link href="../../css/featherlight.min.css" type="text/css" rel="stylesheet" />

<script async defer src="https://buttons.github.io/buttons.js"></script>

<script defer src="../../js/van11y-accessible-hide-show-aria.min.js"></script>

<script defer src="../../js/toc.js"></script>



		<link href="../../blog/forestmode-set-overall-pva-for-variable-with-multiple-levels" rel="canonical">
	</head>

	<body class="restyled-garrick  h-entry">
		<main class="content container" role="main">
			<article class="post">
				<header>
					<a class="u-url" href="../../blog/forestmode-set-overall-pva-for-variable-with-multiple-levels">
						<h1 class="post-title p-name">forestmodel给多水平变量添加整体p值</h1>
					</a>
					<h3 class="post-author">王诗翔</h3>
					<time class="post-date dt-published" datetime="2021-08-31T00:00:00Z">Tuesday, 31 August 2021</time>
					
				</header>
				<div class="post-content e-content">
					<p>前段时间收到来信：</p>
<div class="highlight"><pre style=";-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go">Hi Shixiang 

I am writing to you about the forestmodel <span style="color:#008000;font-weight:bold">package</span> in R. 

Thank you so much <span style="color:#008000;font-weight:bold">for</span> the wonderful <span style="color:#008000;font-weight:bold">package</span> that you created. 

I was wondering <span style="color:#008000;font-weight:bold">if</span> there is a way to display the wald test p<span style="color:#666">-</span>value which is important <span style="color:#008000;font-weight:bold">for</span> variables that have more than two levels. I tried to work around the code but did not find a way out. 

Best 
Aniket 
</code></pre></div><p>我不是作者，搞错了人，问我干啥呢～自个提问嘛</p>
<div class="highlight"><pre style=";-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go">Hi Aniket,

I am not the author of forestmodel, you can see from https:<span style="color:#408080;font-style:italic">//github.com/NikNakk/forestmodel/ or CRAN package info. As for your question, I cannot understand it based on the current info you provided. Could you post an issue on https://github.com/NikNakk/forestmodel/issues?
</span><span style="color:#408080;font-style:italic"></span>
Best,
</code></pre></div><p>很明白的回复吧。这位一点也不尴尬，继续问我。。。还仔细说问题了。</p>
<div class="highlight"><pre style=";-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-fallback" data-lang="fallback">Hi Shixiang 

I posted the issue on github. There is another user who has requested same help. 

It’s basically about displaying a global p-value (from ward test or likelihood ratio test) when there are multiple categories (more than two, for e.g race- Asian, black, Caucasian, Etc) in a variable, in addition to individual p-value against the reference. 

Best 
Aniket 
</code></pre></div><p>好吧，这下让我有点兴趣了。我仔细看了下issue（<a href="https://github.com/NikNakk/forestmodel/issues/31">https://github.com/NikNakk/forestmodel/issues/31</a>），发现提问人是想要把多水平变量的p值展示在森林图上。</p>
<p>我觉得挺没有必要的，而且有点奇怪，为什么呢？我展示了一个示例：</p>
<div class="highlight"><pre style=";-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-R" data-lang="R"><span style="color:#666">&gt;</span> <span style="color:#00f">library</span>(<span style="color:#ba2121">&#34;survival&#34;</span>)
<span style="color:#666">&gt;</span> <span style="color:#00f">library</span>(<span style="color:#ba2121">&#34;dplyr&#34;</span>)
<span style="color:#666">&gt;</span> pretty_lung <span style="color:#666">&lt;-</span> lung <span style="color:#666">%&gt;%</span>
<span style="color:#666">+</span>   <span style="color:#00f">transmute</span>(time,
<span style="color:#666">+</span>             status,
<span style="color:#666">+</span>             Age <span style="color:#666">=</span> age,
<span style="color:#666">+</span>             Sex <span style="color:#666">=</span> <span style="color:#00f">factor</span>(sex, labels <span style="color:#666">=</span> <span style="color:#00f">c</span>(<span style="color:#ba2121">&#34;Male&#34;</span>, <span style="color:#ba2121">&#34;Female&#34;</span>)),
<span style="color:#666">+</span>             ECOG <span style="color:#666">=</span> <span style="color:#00f">factor</span>(lung<span style="color:#666">$</span>ph.ecog),
<span style="color:#666">+</span>             `Meal Cal` <span style="color:#666">=</span> meal.cal
<span style="color:#666">+</span>   )
<span style="color:#666">&gt;</span> <span style="color:#00f">table</span>(lung<span style="color:#666">$</span>ph.ecog)

  <span style="color:#666">0</span>   <span style="color:#666">1</span>   <span style="color:#666">2</span>   <span style="color:#666">3</span> 
 <span style="color:#666">63</span> <span style="color:#666">113</span>  <span style="color:#666">50</span>   <span style="color:#666">1</span> 
<span style="color:#666">&gt;</span> <span style="color:#00f">coxph</span>(<span style="color:#00f">Surv</span>(time, status) <span style="color:#666">~</span> ., pretty_lung)
Call<span style="color:#666">:</span>
<span style="color:#00f">coxph</span>(formula <span style="color:#666">=</span> <span style="color:#00f">Surv</span>(time, status) <span style="color:#666">~</span> ., data <span style="color:#666">=</span> pretty_lung)

                 coef  <span style="color:#00f">exp</span>(coef)   <span style="color:#00f">se</span>(coef)      z       p
Age         <span style="color:#666">7.848e-03</span>  <span style="color:#666">1.008e+00</span>  <span style="color:#666">1.080e-02</span>  <span style="color:#666">0.727</span> <span style="color:#666">0.46727</span>
SexFemale  <span style="color:#666">-5.050e-01</span>  <span style="color:#666">6.035e-01</span>  <span style="color:#666">1.913e-01</span> <span style="color:#666">-2.640</span> <span style="color:#666">0.00829</span>
ECOG1       <span style="color:#666">2.756e-01</span>  <span style="color:#666">1.317e+00</span>  <span style="color:#666">2.221e-01</span>  <span style="color:#666">1.241</span> <span style="color:#666">0.21462</span>
ECOG2       <span style="color:#666">7.852e-01</span>  <span style="color:#666">2.193e+00</span>  <span style="color:#666">2.543e-01</span>  <span style="color:#666">3.087</span> <span style="color:#666">0.00202</span>
ECOG3       <span style="color:#666">1.792e+00</span>  <span style="color:#666">6.004e+00</span>  <span style="color:#666">1.036e+00</span>  <span style="color:#666">1.731</span> <span style="color:#666">0.08348</span>
`Meal Cal` <span style="color:#666">-6.031e-05</span>  <span style="color:#666">9.999e-01</span>  <span style="color:#666">2.300e-04</span> <span style="color:#666">-0.262</span> <span style="color:#666">0.79313</span>

Likelihood ratio test<span style="color:#666">=</span><span style="color:#666">21.56</span>  on <span style="color:#666">6</span> df, p<span style="color:#666">=</span><span style="color:#666">0.001453</span>
n<span style="color:#666">=</span> <span style="color:#666">180</span>, number of events<span style="color:#666">=</span> <span style="color:#666">133</span> 
   (<span style="color:#666">48</span> observations deleted due to missingness)
</code></pre></div><p>这种多变量的cox回归中，p值展示的是整个模型的结果，而ECOG这个因子变量本身建模时被拆分成了3个变量，是没法得到一个p值的。那为啥搞这个呢？</p>
<p>继续的交流了解到他们就是想要进行批量的单变量分析，想要展示整个变量的p值，还给我用图形举例说明了。</p>
<p><img src="https://gitee.com/ShixiangWang/ImageCollection/raw/master/png/202108311958610.png" alt="image-20210831195841536"></p>
<p><img src="https://gitee.com/ShixiangWang/ImageCollection/raw/master/png/202108311959191.png" alt="image-20210831195908154"></p>
<p>了解了问题，再加上我很久之前修改过这个包的源代码，提交过PR，所以大体感觉这个问题不难。想办法把上图中右侧的<code>reference</code>在需要时右侧添加文字就好了。通过添加一个新的参数来控制这种行为。</p>
<p>安装包：</p>
<div class="highlight"><pre style=";-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-R" data-lang="R">remotes<span style="color:#666">::</span><span style="color:#00f">install_github</span>(<span style="color:#ba2121">&#34;ShixiangWang/forestmodel&#34;</span>)
</code></pre></div><p>看看效果：</p>
<div class="highlight"><pre style=";-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-R" data-lang="R"><span style="color:#00f">library</span>(<span style="color:#ba2121">&#34;survival&#34;</span>)
<span style="color:#00f">library</span>(<span style="color:#ba2121">&#34;dplyr&#34;</span>)
<span style="color:#00f">library</span>(<span style="color:#ba2121">&#34;forestmodel&#34;</span>)

pretty_lung <span style="color:#666">&lt;-</span> lung <span style="color:#666">%&gt;%</span>
  <span style="color:#00f">transmute</span>(time,
            status,
            Age <span style="color:#666">=</span> age,
            Sex <span style="color:#666">=</span> <span style="color:#00f">factor</span>(sex, labels <span style="color:#666">=</span> <span style="color:#00f">c</span>(<span style="color:#ba2121">&#34;Male&#34;</span>, <span style="color:#ba2121">&#34;Female&#34;</span>)),
            ECOG <span style="color:#666">=</span> <span style="color:#00f">factor</span>(lung<span style="color:#666">$</span>ph.ecog),
            `Meal Cal` <span style="color:#666">=</span> meal.cal
  )

<span style="color:#00f">print</span>(<span style="color:#00f">forest_model</span>(<span style="color:#00f">coxph</span>(<span style="color:#00f">Surv</span>(time, status) <span style="color:#666">~</span> ., pretty_lung), show_global_p <span style="color:#666">=</span> <span style="color:#ba2121">&#34;bottom&#34;</span>))
<span style="color:#00f">print</span>(<span style="color:#00f">forest_model</span>(<span style="color:#00f">coxph</span>(<span style="color:#00f">Surv</span>(time, status) <span style="color:#666">~</span> ., pretty_lung), show_global_p <span style="color:#666">=</span> <span style="color:#ba2121">&#34;aside&#34;</span>))
</code></pre></div><p><img src="https://gitee.com/ShixiangWang/ImageCollection/raw/master/png/202108312021863.png" alt="image-20210831202115822"></p>
<blockquote>
<p>在实现的过程中发现将global p值加到最下方也是有益的，并不仅限于单因素模型使用。</p>
</blockquote>
<p><img src="https://gitee.com/ShixiangWang/ImageCollection/raw/master/png/202108312004901.png" alt="image-20210831200453864"></p>
<div class="highlight"><pre style=";-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-R" data-lang="R"><span style="color:#00f">print</span>(<span style="color:#00f">forest_model</span>(<span style="color:#00f">coxph</span>(<span style="color:#00f">Surv</span>(time, status) <span style="color:#666">~</span> ECOG, pretty_lung), show_global_p <span style="color:#666">=</span> <span style="color:#ba2121">&#34;aside&#34;</span>))
</code></pre></div><p><img src="https://gitee.com/ShixiangWang/ImageCollection/raw/master/png/202108312005144.png" alt="image-20210831200526104"></p>
<p>由于我之前开发的ezcox包可以直接接收传到forestmodel的其他参数，所以只要无需改动ezcox就完成了对该包该特性的支持。有使用ezcox包的读者可以试试。</p>
<p>由于做了不少维护和开发工作，就这两天forestmodel作者将我加入了<a href="https://github.com/NikNakk/forestmodel/blob/d001c80f5b001ff8c4c82201b1f223be64415b8b/DESCRIPTION#L9">作者列表</a>。这算是无心插柳吗？</p>

				</div>
				<footer class="footer">
				  <hr>
<div class="post-tags">

<p>
  <svg xmlns="http://www.w3.org/2000/svg" class="octicon" width="20" height="24" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M8 2H6V0h2v2zm4 5H2c-.55 0-1-.45-1-1V4c0-.55.45-1 1-1h10l2 2-2 2zM8 4H6v2h2V4zM6 16h2V8H6v8z"/></svg>
	
	<a class="p-category" href="../../categories/blog/">Blog</a>
</p>


<p>
  <svg xmlns="http://www.w3.org/2000/svg" class="octicon" width="20" height="24" viewBox="0 0 15 16"><path fill-rule="evenodd" d="M7.73 1.73C7.26 1.26 6.62 1 5.96 1H3.5C2.13 1 1 2.13 1 3.5v2.47c0 .66.27 1.3.73 1.77l6.06 6.06c.39.39 1.02.39 1.41 0l4.59-4.59a.996.996 0 0 0 0-1.41L7.73 1.73zM2.38 7.09c-.31-.3-.47-.7-.47-1.13V3.5c0-.88.72-1.59 1.59-1.59h2.47c.42 0 .83.16 1.13.47l6.14 6.13-4.73 4.73-6.13-6.15zM3.01 3h2v2H3V3h.01z"/></svg>
	
	<a class="p-tag" href="../../tags/r/">R</a><a class="p-tag" href="../../tags/forestmodel/">forestmodel</a>

</p>
</div>

				</footer>
			</article>
		</main>
			  <button class="hamburger hamburger--arrow is-active" type="button" onclick="document.getElementsByClassName('sidebar')[0].classList.toggle('collapsed');document.getElementsByClassName('content')[0].classList.toggle('expanded');document.getElementsByClassName('hamburger')[0].classList.toggle('is-active');document.getElementsByClassName('hamburger-inner')[0].classList.toggle('is-active')">
      <span class="hamburger-box">
        <span class="hamburger-inner"></span>
      </span>
    </button>
		<aside class="sidebar">
			<div class="container sidebar-sticky">
				<header class="sidebar-about h-card vcard p-author">
					
					<a class="u-url u-uid" rel="me" href="../../">
						<img class="u-photo" src="https://avatars.githubusercontent.com/u/25057508?v=4" width=128 height=128 />
					</a>
					

					
					<span class="site-title u-name fn">
					  <a class="u-url u-uid" rel="me" href="../../">ShixiangWang
王诗翔</a>
				  </span>
					

					<p class="lead p-note">
						 Bioinformatics Scholar. Cancer Researcher. Data Scientist. #rstats #python #rust. Always learning something new. 
					</p>

					<nav>
						<ul class="sidebar-nav">
							
							<li><a href="../../about/"> About </a></li>
							
							<li><a href="../../blog/"> Blog </a></li>
							
							<li><a href="../../project/"> Projects </a></li>
							
							<li><a href="http://42.192.87.178:3838/"> Shiny Apps </a></li>
							
							<li><a href="../../talk/"> Talks </a></li>
							
							<li><a href="https://github.com/ShixiangWang/self-study/discussions"> Discuss with me? </a></li>
							
							<li><a href="https://shixiangwang.netlify.app/"> Mirror #1 </a></li>
							
							<li><a href="https://shixiangwang.github.io/"> Mirror #2 </a></li>
							
						</ul>
					</nav>

					
						<div class="contact">
						  
							<ul class="contact-list">
								
								<li>
									
									  
		  							  <a href="https://twitter.com/WangShxiang" class="u-url url" rel="me" title="Twitter" aria-label="Twitter">
		  						    <i class='fab fa-twitter fa-fw'></i>
		  							  </a>
		  						  
								
								</li>
								
								<li>
									
									  
		  							  <a href="https://github.com/ShixiangWang" class="u-url url" rel="me" title="GitHub" aria-label="GitHub">
		  						    <i class='fab fa-github fa-fw'></i>
		  							  </a>
		  						  
								
								</li>
								
								<li>
									
		  							<a href="mailto:shixiang1994wang@gmail.com" class="u-email email" rel="me" title="Email" aria-label="Email">
		  							<i class='fa fa-envelope fa-fw'></i>
		  							  
		  							</a>
									
								</li>
								
								<li>
									
									  
		  							  <a href="https://shixiangwang.github.io/home/logo/qrcode.jpg" class="u-url url" rel="me" title="Bandcamp" aria-label="Bandcamp">
		  						    <i class='fab fa-bandcamp fa-fw'></i>
		  							  </a>
		  						  
								
								</li>
								
							</ul>
						</div>
					
				</header>

				<footer>&copy; 2021. All rights reserved. </footer>
				 <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <span id="busuanzi_container_site_pv">本站总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>&nbsp;次</span>
			</div>
		</aside>

		  <footer>
  <script src="../../js/jquery-latest.js"></script>
<script src="../../js/featherlight.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
  
  </footer>
  </body>
</html>

	</body>
</html>
