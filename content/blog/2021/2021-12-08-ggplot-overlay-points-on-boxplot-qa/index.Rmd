---
title: ggplot结合点图与箱线图的问题与解决
author: 王诗翔
date: '2021-12-08'
slug: ggplot-overlay-points-on-boxplot-qa
categories:
  - Blog
tags:
  - R
  - ggplot
description: 怎么分组就无法识别了呢？
---

<!-- Links -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, warning = FALSE, message = FALSE,
  fig.width = 7, fig.height = 6
)
```

最近在使用ggplot2对箱线图叠加点图是发现奇怪的现象，只要我改变点的形状，绘图就出问题了。

下面我通过一个简单的示例展示这个问题。

我们先生成一组简单的数据，并绘制一个正常的叠加图：

```{r}
library(ggplot2)
library(dplyr)

head(mtcars)

data = data.frame(
  x = factor(mtcars$vs),
  y = mtcars$wt,
  fill = factor(mtcars$am)
) %>% 
  dplyr::arrange(x, fill) %>% 
  dplyr::mutate(shape = rep(letters[1:4], 8))

set.seed(1)
ggplot(data, aes(x, y, fill = fill)) +
  geom_boxplot() +
  geom_point(position=position_jitterdodge())
```

这里参考了[Overlay geom_points() on geom_boxplot(fill=group)?](https://stackoverflow.com/questions/21468380/overlay-geom-points-on-geom-boxplotfill-group)
来解决点也需要分配到不同的fill组中的问题。

下面就是见证奇怪的时刻：

```{r}
set.seed(1)
ggplot(data, aes(x, y, fill = fill)) +
  geom_boxplot() +
  geom_point(aes(shape = shape), position=position_jitterdodge())
```

如果我们对比上面这个图和第一个图，很容易发现点的坐标变化了！
而我们代码的唯一修改就是增加了`shape`映射以修改点的形状。

我百思不得其解，ggplot完全没有干好它该干的事情嘛。

最后我把问题抛到了stack overflow，很快[Jon Spring](https://stackoverflow.com/users/6851825/jon-spring)
进行了解惑：

> 在这种情况下，我们希望位置抖动“意识到”存在填充美学映射的两个分类。
因为这里的形状没有填充美学映射，在应用抖动之前，该层不会自动分离两个填充分类值。
>
> <https://stackoverflow.com/questions/70254769/overlay-geom-pointsaesshape-on-geom-boxplot/70264459#70264459>

大概理解起来就是说这里的shape几何对象无法利用`fill`这个属性，那么需要让因此我们可以手动指定数据的分组，让绘点的这个图层意识到分组的存在。

```{r}
set.seed(1)
ggplot(data, aes(x, y, fill = fill)) +
  geom_boxplot() +
  geom_point(aes(shape = shape, group = fill), position=position_jitterdodge())
```
